var voiceControl={recorder:null,voice:null,language:"Chinese",debug:!1};function startRecording(){if(voiceControl.recorder)return voiceControl.recorder.clear(),void voiceControl.recorder.start();HZRecorder.get(function(e){voiceControl.recorder=e,voiceControl.recorder.start()})}function endrecording(){return new Promise(function(t){var e,r;voiceControl.recorder&&(voiceControl.recorder.stop(),voiceControl.voice=voiceControl.recorder.getBlob(),voiceControl.recorder.clear()),$(".messages").html("loading~"),(e=voiceControl.voice.blob,r=new FileReader,r.readAsDataURL(e),new Promise(function(t){r.onload=function(){base64Data=r.result.replace(/^data:audio\/\wav+;base64,/,""),$.ajax({method:"POST",url:"server/listen/lservice.php",data:{lang:voiceControl.language,audio:base64Data}}).done(function(e){data=JSON.parse(e),baidu=JSON.parse(data.baidu),xunfei=JSON.parse(data.xunfei),0==baidu.state?baiduMessage=baidu.data:baiduMessage=baidu.error.err_msg,0==xunfei.state?xunfeiMessage=xunfei.data:xunfeiMessage=xunfei.error.err_msg,voiceControl.debug?(console.log(baidu),console.log(xunfei),$(".messages").html("results: <br /> baidu:"+baiduMessage+"<br /> xunfei:"+xunfeiMessage+"<br /> caozuo:"+data.caozuo)):$(".messages").html("done"),console.log(baidu.data),t(data.caozuo)}).fail(function(){$(".messages").html("server error")})}})).then(function(e){console.log(e),t(e)})})}function getlanguage(){voiceControl.language=$('input[name="language"]:checked').val()}!function(s){s.URL=s.URL||s.webkitURL,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var a=function(e,t){(t=t||{}).sampleBits=t.sampleBits||16,t.sampleRate=t.sampleRate||16e3,audioContext=s.AudioContext||s.webkitAudioContext;var r=new audioContext,o=r.createMediaStreamSource(e),a=r.createGain();o.connect(a),r.onstatechange=function(){console.log("state",r.state)};var n=r.createScriptProcessor(4096,2,2),i={size:0,buffer:[],inputSampleRate:r.sampleRate,inputSampleBits:16,outputSampleRate:t.sampleRate,oututSampleBits:t.sampleBits,input:function(e){this.buffer.push(new Float32Array(e)),this.size+=e.length},compress:function(){for(var e=new Float32Array(this.size),t=0,r=0;r<this.buffer.length;r++)e.set(this.buffer[r],t),t+=this.buffer[r].length;for(var o=parseInt(this.inputSampleRate/this.outputSampleRate),a=e.length/o,n=new Float32Array(a),i=0,s=0;i<a;)n[i]=e[s],s+=o,i++;return n},encodeWAV:function(){var e=Math.min(this.inputSampleRate,this.outputSampleRate),t=Math.min(this.inputSampleBits,this.oututSampleBits),r=this.compress(),o=r.length*(t/8),a=new ArrayBuffer(44+o),n=new DataView(a),i=0,s=function(e){for(var t=0;t<e.length;t++)n.setUint8(i+t,e.charCodeAt(t))};if(s("RIFF"),i+=4,n.setUint32(i,36+o,!0),i+=4,s("WAVE"),i+=4,s("fmt "),i+=4,n.setUint32(i,16,!0),i+=4,n.setUint16(i,1,!0),i+=2,n.setUint16(i,1,!0),i+=2,n.setUint32(i,e,!0),i+=4,n.setUint32(i,1*e*(t/8),!0),i+=4,n.setUint16(i,t/8*1,!0),i+=2,n.setUint16(i,t,!0),i+=2,s("data"),i+=4,n.setUint32(i,o,!0),i+=4,8===t)for(var u=0;u<r.length;u++,i++){var c=(l=Math.max(-1,Math.min(1,r[u])))<0?32768*l:32767*l;c=parseInt(255/(65535/(c+32768))),n.setInt8(i,c,!0)}else for(u=0;u<r.length;u++,i+=2){var l=Math.max(-1,Math.min(1,r[u]));n.setInt16(i,l<0?32768*l:32767*l,!0)}return new Blob([n],{type:"audio/wav"})}};this.start=function(){o.connect(n),n.connect(r.destination)},this.stop=function(){return n.disconnect(),console.log("stoped",i.buffer.length),i.buffer.length},this.getBlob=function(){return{duration:this.stop(),blob:i.encodeWAV()}},this.clear=function(){i.buffer=[],i.size=0},this.play=function(e,t){t=t||this.getBlob().blob,e.src=s.URL.createObjectURL(t)},n.onaudioprocess=function(e){i.input(e.inputBuffer.getChannelData(0))}};a.throwError=function(e){console.error(e)},a.canRecording=!!navigator.getUserMedia,a.get=function(r,o){if(a.throwError=o&&o.error||a.throwError,r){if(!navigator.getUserMedia)return void a.throwErr("浏览器不支持录音功能。");navigator.getUserMedia({audio:!0},function(e){var t=new a(e,o);r(t)},function(e){switch(e.code||e.name){case"PERMISSION_DENIED":case"PermissionDeniedError":a.throwError("用户拒绝提供信息。");break;case"NOT_SUPPORTED_ERROR":case"NotSupportedError":a.throwError("浏览器不支持录音功能。");break;case"MANDATORY_UNSATISFIED_ERROR":case"MandatoryUnsatisfiedError":a.throwError("无法发现指定的硬件设备。");break;default:a.throwError("无法打开麦克风。异常信息:"+(e.code||e.name))}})}},s.HZRecorder=a}(window);